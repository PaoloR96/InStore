version: '3.8'
#TODO eliminare i commenti
#TODO eliminare directory VaultService
#TODO eliminare dockerfile in mysqlserivce
#TODO variabili d'ambiente per mysl-password e token-vault

services:
  mysql-db:
    image: mysql:9.2.0
    container_name: Mysql_Service
#    restart: unless-stopped
    networks:
      - app-network
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: "InStore_db"
      MYSQL_ROOT_PASSWORD: "rootpassword"
    volumes:
      #- mysql-data:/var/lib/mysql
      - ./MySqlService/persistence:/var/lib/mysql

  # Servizio Keycloak per la gestione dell'autenticazione
#  keycloak:
#    build: ./KeycloakService                        # path of dockerfile
#    container_name: Keycloak_Manager
#    ports:
#      - "8090:8090"                                 # Mappa la porta 8090 per l'accesso a Keycloak
#    volumes:
#      - ./KeycloakService/data:/opt/keycloak/data
#    networks:
#      - app-network

  vault:
    image: hashicorp/vault:1.18.4
    container_name: vault-service
#    restart: unless-stopped
    ports:
      - '8200:8200'
    volumes:
      - ./vault/config:/vault/config
      - ./vault/policies:/vault/policies
      - ./vault/data:/vault/data
      - ./vault/logs:/vault/logs
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_API_ADDR: "http://0.0.0.0:8200"
    networks:
      - app-network
    cap_add:
      - IPC_LOCK
    entrypoint: vault server -config=/vault/config/config.hcl


  vault-init:
    container_name: vault-init
    image: hashicorp/vault:1.18.4
    restart: "no"
    environment:
      VAULT_ADDR: "http://vault-service:8200"
    volumes:
      - ./vault/unseal-vault.sh:/vault/unseal-vault.sh
    entrypoint: sh -c "sleep 5 && /vault/unseal-vault.sh"
    networks:
      - app-network
    cap_add:
      - IPC_LOCK
    depends_on:
      - vault

  application-core:
    build:
      context: ./ApplicationCore
      dockerfile: Dockerfile
    container_name: ApplicationCore_Service
#    restart: unless-stopped
    environment:
      VAULT_TOKEN: "hvs.6cW8zKkrzeQA17xZAQvu0GeS"
    networks:
      - app-network
    depends_on:
      - mysql-db
      - vault-init
#      - keycloak
    ports:
      - "8081:8080"
#    entrypoint: ["/bin/bash", "-c", "while true; do sleep 30; done"]

# Definizione delle reti utilizzate dai vari servizi
networks:
  app-network:
    external: true  # Rete esterna gi√† esistente per i contenitori

# Definizione dei volumi per la persistenza dei dati
volumes:
  mysql-data:  # Volume per i dati di MySQL

